<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doodle Jump : Monster Edition</title>
    <style>
        body { margin: 0; background: #050505; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: sans-serif; }
        canvas { border: 4px solid #444; background: #111; box-shadow: 0 0 30px rgba(0,255,255,0.2); }
        #ui { position: absolute; top: 20px; color: #fff; font-size: 24px; text-shadow: 0 0 10px #0ff; pointer-events: none; }
    </style>
</head>
<body>

<div id="ui">SCORE: <span id="score">0</span></div>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');

canvas.width = 400;
canvas.height = 600;

let score = 0;
let cameraY = 0;
let gameActive = true;

const player = {
    x: 200, y: 500, w: 25, h: 25,
    vx: 0, vy: 0,
    jump: -11,
    gravity: 0.35
};

let platforms = [];
let monsters = [];
const platformW = 65;
const platformH = 12;

function createPlatform(y) {
    const rand = Math.random();
    let type = 'normal';
    if (rand > 0.85) type = 'moving';
    else if (rand > 0.75) type = 'breakable';
    
    // Chance de spawn un monstre au-dessus de la plateforme
    if (Math.random() > 0.92 && score > 500) {
        monsters.push({
            x: Math.random() * (canvas.width - 30),
            y: y - 80,
            w: 30, h: 30,
            vx: 2,
            dead: false
        });
    }

    return {
        x: Math.random() * (canvas.width - platformW),
        y: y,
        type: type,
        dir: Math.random() > 0.5 ? 1 : -1,
        broken: false,
        opacity: 1,
        hasSpring: Math.random() > 0.92 && type === 'normal'
    };
}

function init() {
    platforms = [];
    monsters = [];
    for (let i = 0; i < 8; i++) {
        platforms.push(createPlatform(canvas.height - (i * 85) - 50));
    }
    platforms[0].type = 'normal';
    platforms[0].x = 160;
}

const keys = {};
window.onkeydown = (e) => keys[e.code] = true;
window.onkeyup = (e) => keys[e.code] = false;

function update() {
    if (!gameActive) return;

    if (keys['ArrowLeft']) player.vx -= 0.7;
    if (keys['ArrowRight']) player.vx += 0.7;
    player.vx *= 0.85;
    player.x += player.vx;

    if (player.x > canvas.width) player.x = -player.w;
    if (player.x < -player.w) player.x = canvas.width;

    player.vy += player.gravity;
    player.y += player.vy;

    // Collisions Plateformes
    if (player.vy > 0) {
        platforms.forEach(p => {
            if (!p.broken && player.x + player.w > p.x && player.x < p.x + platformW &&
                player.y + player.h > p.y && player.y + player.h < p.y + platformH + player.vy) {
                let force = player.jump;
                if (p.hasSpring) { force *= 1.8; p.hasSpring = false; }
                if (p.type === 'breakable') p.broken = true;
                player.vy = force;
            }
        });
    }

    // Collisions Monstres
    monsters.forEach(m => {
        if (!m.dead) {
            m.x += m.vx;
            if (m.x <= 0 || m.x >= canvas.width - m.w) m.vx *= -1;

            if (player.x + player.w > m.x && player.x < m.x + m.w &&
                player.y + player.h > m.y && player.y < m.y + m.h) {
                
                // Si on tombe sur le monstre
                if (player.vy > 0 && player.y + player.h < m.y + m.h / 2 + player.vy) {
                    player.vy = player.jump * 1.5; // Grand rebond
                    m.dead = true;
                } else {
                    gameActive = false; // Touché par le côté/bas
                }
            }
        } else {
            m.y += 10; // Le monstre tombe
        }
    });

    // Scroll Caméra
    if (player.y < canvas.height / 2) {
        let diff = canvas.height / 2 - player.y;
        player.y = canvas.height / 2;
        cameraY += diff;
        score = Math.floor(cameraY);
        scoreEl.innerText = score;

        platforms.forEach(p => {
            p.y += diff;
            if (p.y > canvas.height) Object.assign(p, createPlatform(0));
        });
        monsters.forEach(m => m.y += diff);
    }

    // Nettoyage monstres
    monsters = monsters.filter(m => m.y < canvas.height);

    platforms.forEach(p => {
        if (p.type === 'moving') {
            p.x += 2 * p.dir;
            if (p.x <= 0 || p.x >= canvas.width - platformW) p.dir *= -1;
        }
        if (p.broken && p.opacity > 0) p.opacity -= 0.1;
    });

    if (player.y > canvas.height) gameActive = false;
}

function draw() {
    ctx.fillStyle = '#111';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Plateformes
    platforms.forEach(p => {
        if (p.opacity <= 0) return;
        ctx.globalAlpha = p.opacity;
        ctx.shadowBlur = 10;
        if (p.type === 'normal') { ctx.fillStyle = '#0f0'; ctx.shadowColor = '#0f0'; }
        if (p.type === 'moving') { ctx.fillStyle = '#f0f'; ctx.shadowColor = '#f0f'; }
        if (p.type === 'breakable') { ctx.fillStyle = '#f33'; ctx.shadowColor = '#f33'; }
        ctx.fillRect(p.x, p.y, platformW, platformH);
        if (p.hasSpring) {
            ctx.fillStyle = '#ff0'; ctx.shadowColor = '#ff0';
            ctx.fillRect(p.x + platformW/2 - 5, p.y - 10, 10, 10);
        }
    });

    // Monstres
    monsters.forEach(m => {
        ctx.globalAlpha = 1;
        ctx.fillStyle = m.dead ? '#555' : '#ffaa00';
        ctx.shadowBlur = m.dead ? 0 : 15;
        ctx.shadowColor = '#ffaa00';
        ctx.beginPath();
        ctx.arc(m.x + m.w/2, m.y + m.h/2, m.w/2, 0, Math.PI * 2);
        ctx.fill();
        // Yeux du monstre
        ctx.fillStyle = 'black';
        ctx.fillRect(m.x + 8, m.y + 10, 4, 4);
        ctx.fillRect(m.x + 18, m.y + 10, 4, 4);
    });

    // Joueur
    ctx.globalAlpha = 1;
    ctx.fillStyle = '#0ff';
    ctx.shadowBlur = 15;
    ctx.shadowColor = '#0ff';
    ctx.fillRect(player.x, player.y, player.w, player.h);

    if (gameActive) {
        requestAnimationFrame(() => { update(); draw(); });
    } else {
        ctx.fillStyle = 'rgba(0,0,0,0.8)';
        ctx.fillRect(0,0,400,600);
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.font = '30px Arial';
        ctx.fillText("GAME OVER", 200, 300);
        ctx.font = '20px Arial';
        ctx.fillText("SCORE: " + score, 200, 340);
        ctx.font = '15px Arial';
        ctx.fillText("Appuie sur F5 pour rejouer", 200, 380);
    }
}

init();
draw();
</script>
</body>
</html>
